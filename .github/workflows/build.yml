# .github/workflows/build.yml
name: OS Build & Test

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Tools
        run: sudo apt-get update && sudo apt-get install -y nasm gcc qemu-system-x86

      - name: Create build directory
        run: mkdir -p build

      - name: Assemble Bootloader
        run: nasm -f elf32 boot/bootloader.asm -o boot/bootloader.o

      - name: Compile Kernel
        run: |
          gcc -m32 -c kernel/main.c -o kernel/main.o \
            -ffreestanding -nostdinc -fno-stack-protector \
            -Ikernel -I.
          gcc -m32 -c kernel/video.c -o kernel/video.o \
            -ffreestanding -nostdinc -fno-stack-protector \
            -Ikernel -I.
          gcc -m32 -c kernel/filesystem.c -o kernel/filesystem.o \
            -ffreestanding -nostdinc -fno-stack-protector \
            -Ikernel -I.

      - name: Link Kernel
        run: |
          ld -m elf_i386 -T tools/linker.ld -o build/kernel.bin \
            boot/bootloader.o kernel/*.o

      - name: Run in QEMU
        run: timeout 5s qemu-system-i386 \
          -nographic -serial stdio -kernel build/kernel.bin || true
